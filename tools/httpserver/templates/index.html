<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOP Data Browser</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; display: flex; height: 100vh; }
        #sidebar { width: 250px; min-width: 150px; max-width: 50%; background: #f4f4f4; border-right: 1px solid #ddd; padding: 20px; overflow-y: auto; flex-shrink: 0; box-sizing: border-box; }
        #resizer { width: 5px; background: #ddd; cursor: col-resize; user-select: none; transition: background 0.2s; flex-shrink: 0; }
        #resizer:hover, #resizer.resizing { background: #007bff; }
        #detail-resizer { width: 5px; background: #ddd; cursor: col-resize; user-select: none; transition: background 0.2s; flex-shrink: 0; display: none; }
        #detail-resizer:hover, #detail-resizer.resizing { background: #007bff; }
        #main { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; min-width: 0; }
        h1, h2 { margin-top: 0; }
        ul { list-style: none; padding: 0; }
        li { padding: 8px 12px; cursor: pointer; border-radius: 4px; margin-bottom: 4px; }
        li:hover { background: #e0e0e0; }
        li.active { background: #007bff; color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; border: 1px solid #ccc; }
        th, td { text-align: left; padding: 6px 12px; border: 1px solid #ccc; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        th { position: relative; background-color: #f2f2f2; }
        th.th-key { color: #155724; font-weight: bold; }
        th.th-val { }
        .col-resizer { position: absolute; right: 0; top: 0; bottom: 0; width: 5px; cursor: col-resize; user-select: none; }
        .col-resizer:hover { background: #007bff; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #e6e6e6; cursor: pointer; }
        tr.selected-row { background-color: #cce5ff !important; }
        #detail-panel { width: 400px; border-left: 1px solid #ddd; padding: 20px; background: #fff; display: none; overflow-y: auto; box-sizing: border-box; flex-shrink: 0; }
        pre { background: #f8f8f8; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .toolbar { display: flex; gap: 10px; margin-bottom: 20px; }
        input[type="text"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; flex: 1; }
        button { padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>Stores</h2>
    <ul id="store-list">
        <li>Loading...</li>
    </ul>
</div>

<div id="resizer"></div>

<div id="main">
    <h1 id="current-store-title">Select a Store</h1>
    
    <div class="toolbar" id="toolbar" style="display:none;">
        <input type="text" id="search-input" placeholder="Search keys...">
        <button onclick="loadItems('search')">Search</button>
        <button onclick="showAdd()" style="background: #28a745;">Add Item</button>
    </div>

    <div id="pagination-top" style="display:none; margin-bottom: 10px; gap: 10px; justify-content: center;">
        <button onclick="firstPage()">First</button>
        <button onclick="prevPage()">Previous</button>
        <button onclick="nextPage()">Next</button>
        <button onclick="lastPage()">Last</button>
    </div>

    <div id="data-grid"></div>
    
    <div id="pagination" style="display:none; margin-top: 10px; gap: 10px; justify-content: center;">
        <button onclick="firstPage()">First</button>
        <button onclick="prevPage()">Previous</button>
        <button onclick="nextPage()">Next</button>
        <button onclick="lastPage()">Last</button>
    </div>
</div>

<div id="detail-resizer"></div>

<div id="detail-panel">
    <h2>Item Details</h2>
    <div id="json-viewer"></div>
</div>

<script>
    let currentStore = null;
    let firstKey = null;
    let lastKey = null;
    let currentStoreInfo = null;
    let currentItemKey = null;
    let currentItems = [];
    let currentKeyColumnWidth = '45%';

    // Load Stores on Start
    fetch('/api/stores')
        .then(res => res.json())
        .then(stores => {
            const list = document.getElementById('store-list');
            list.innerHTML = '';
            stores.forEach(store => {
                const li = document.createElement('li');
                li.textContent = store;
                li.onclick = () => selectStore(store, li);
                list.appendChild(li);
            });
        })
        .catch(err => {
            const list = document.getElementById('store-list');
            list.innerHTML = `<li style="color: red;">Error: ${err.message}</li>`;
        });

    function selectStore(name, element) {
        currentStore = name;
        
        // Highlight active
        document.querySelectorAll('#sidebar li').forEach(el => el.classList.remove('active'));
        element.classList.add('active');

        // Fetch Store Info
        fetch(`/api/store/info?name=${encodeURIComponent(name)}`)
            .then(res => res.json())
            .then(info => {
                currentStoreInfo = info;
                // Use description if available, otherwise name
                const displayTitle = info.description ? info.description : info.name;
                document.getElementById('current-store-title').textContent = displayTitle;

                buildSearchUI(info);
                loadItems('first');
            });
    }

    function buildSearchUI(info) {
        const toolbar = document.getElementById('toolbar');
        toolbar.innerHTML = ''; // Clear existing
        toolbar.style.display = 'flex';
        toolbar.style.flexWrap = 'wrap';

        if (info.indexSpec && info.indexSpec.index_fields) {
            // Complex Key with Index Spec
            info.indexSpec.index_fields.forEach(field => {
                const input = document.createElement('input');
                input.type = 'text';
                input.id = `search-field-${field.field_name}`;
                input.placeholder = `${field.field_name} (${field.ascending_sort_order ? 'Asc' : 'Desc'})`;
                input.style.marginRight = '5px';
                input.style.flex = '1 1 150px'; // Allow wrapping
                toolbar.appendChild(input);
            });
        } else {
            // Primitive Key or no spec
            const input = document.createElement('input');
            input.type = 'text';
            input.id = 'search-input';
            input.placeholder = 'Search keys...';
            input.style.flex = '1';
            toolbar.appendChild(input);
        }

        const btn = document.createElement('button');
        btn.textContent = 'Search';
        btn.onclick = () => loadItems('search');
        toolbar.appendChild(btn);

        const addBtn = document.createElement('button');
        addBtn.textContent = 'Add Item';
        addBtn.onclick = () => showAdd();
        addBtn.style.background = '#28a745';
        addBtn.style.marginLeft = '10px';
        toolbar.appendChild(addBtn);
    }

    function loadItems(action = 'first', refKey = null) {
        if (!currentStore) return;
        
        let url = `/api/store/items?name=${encodeURIComponent(currentStore)}`;
        
        if (action === 'search') {
             let query = "";
             if (currentStoreInfo && currentStoreInfo.indexSpec && currentStoreInfo.indexSpec.index_fields) {
                 // Construct JSON object from fields
                 const queryObj = {};
                 let hasValue = false;
                 currentStoreInfo.indexSpec.index_fields.forEach(field => {
                     const val = document.getElementById(`search-field-${field.field_name}`).value;
                     if (val) {
                         // Try to parse number if possible, else string
                         const numVal = Number(val);
                         queryObj[field.field_name] = isNaN(numVal) ? val : numVal;
                         hasValue = true;
                     }
                 });
                 if (hasValue) {
                     query = JSON.stringify(queryObj);
                 }
             } else {
                 query = document.getElementById('search-input').value;
             }
             
             if (query) {
                url += `&q=${encodeURIComponent(query)}`;
             } else {
                 // If search is empty, treat as first
                 action = 'first';
                 url += `&action=${action}`;
             }
        } else {
             url += `&action=${action}`;
             if (refKey) {
                 const keyStr = typeof refKey === 'object' ? JSON.stringify(refKey) : refKey;
                 url += `&key=${encodeURIComponent(keyStr)}`;
             }
        }

        return fetch(url)
            .then(res => res.json())
            .then(items => {
                currentItems = items || [];
                const grid = document.getElementById('data-grid');
                const pagination = document.getElementById('pagination');
                const paginationTop = document.getElementById('pagination-top');
                
                if (!items || items.length === 0) {
                    grid.innerHTML = '<p>No items found. <button onclick="loadItems(\'first\')">Go to First</button></p>';
                    pagination.style.display = 'none';
                    paginationTop.style.display = 'none';
                    firstKey = null;
                    lastKey = null;
                    return items;
                }

                // Update keys
                firstKey = items[0].key;
                lastKey = items[items.length - 1].key;
                
                // Show pagination
                pagination.style.display = 'flex';
                paginationTop.style.display = 'flex';

                // --- DYNAMIC TABLE GENERATION ---
                let keyCols = [];
                let valCols = [];
                
                if (items.length > 0) {
                    const sampleKey = items[0].key;
                    const sampleVal = items[0].value;
                    
                    if (typeof sampleKey === 'object' && sampleKey !== null) {
                        keyCols = Object.keys(sampleKey);
                    } else {
                        keyCols = ['Key'];
                    }
                    
                    if (typeof sampleVal === 'object' && sampleVal !== null) {
                        valCols = Object.keys(sampleVal);
                    } else {
                        valCols = ['Value'];
                    }
                } else {
                    keyCols = ['Key'];
                    valCols = ['Value'];
                }

                let html = '<table id="items-table"><thead><tr>';
                
                // Key Headers
                keyCols.forEach(col => {
                     html += `<th class="th-key">${col} <div class="col-resizer" onmousedown="initColResize(event)"></div></th>`;
                });
                
                // Value Headers
                valCols.forEach(col => {
                     html += `<th class="th-val">${col} <div class="col-resizer" onmousedown="initColResize(event)"></div></th>`;
                });
                
                html += '</tr></thead><tbody>';
                
                items.forEach(item => {
                    // Escape single quotes for the onclick attribute
                    const itemJson = JSON.stringify(item).replace(/'/g, "&#39;");
                    html += `<tr onclick='showDetail(this, ${itemJson})'>`;
                    
                    // Key Cells
                    if (keyCols.length === 1 && keyCols[0] === 'Key') {
                         const val = typeof item.key === 'object' ? JSON.stringify(item.key) : item.key;
                         html += `<td title="${String(val).replace(/"/g, '&quot;')}">${val}</td>`;
                    } else {
                        keyCols.forEach(col => {
                            let val = item.key ? item.key[col] : '';
                            if (typeof val === 'object') val = JSON.stringify(val);
                            html += `<td title="${String(val).replace(/"/g, '&quot;')}">${val}</td>`;
                        });
                    }
                    
                    // Value Cells
                    if (valCols.length === 1 && valCols[0] === 'Value') {
                         const val = typeof item.value === 'object' ? JSON.stringify(item.value) : item.value;
                         html += `<td title="${String(val).replace(/"/g, '&quot;')}">${val}</td>`;
                    } else {
                        valCols.forEach(col => {
                            let val = item.value ? item.value[col] : '';
                            if (typeof val === 'object') val = JSON.stringify(val);
                            html += `<td title="${String(val).replace(/"/g, '&quot;')}">${val}</td>`;
                        });
                    }
                    
                    html += '</tr>';
                });
                html += '</tbody></table>';
                grid.innerHTML = html;
                return items;
            });
    }

    function firstPage() { loadItems('first'); }
    function lastPage() { loadItems('last'); }
    function nextPage() { loadItems('next', lastKey); }
    function prevPage() { loadItems('prev', firstKey); }

    function showDetail(row, item) {
        // Highlight selected row
        if (row) {
            document.querySelectorAll('#items-table tr').forEach(tr => tr.classList.remove('selected-row'));
            row.classList.add('selected-row');
        }

        const panel = document.getElementById('detail-panel');
        const viewer = document.getElementById('json-viewer');
        currentItemKey = item.key;
        
        const keyStr = typeof item.key === 'object' ? JSON.stringify(item.key, null, 2) : item.key;
        const valStr = JSON.stringify(item.value, null, 2);

        viewer.innerHTML = `
            <div style="margin-bottom: 10px;">
                <strong>Key:</strong>
                <pre style="margin-top: 5px; background: #eee; padding: 5px;">${keyStr}</pre>
            </div>
            <div style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                <strong>Value:</strong>
                <button onclick="closeDetail()" style="padding: 2px 8px; font-size: 12px;">Close</button>
            </div>
            <div style="margin-bottom: 10px;">
                <textarea id="edit-value" oninput="document.getElementById('btn-save').disabled = false;" style="width: 100%; height: 300px; font-family: monospace; margin-top: 5px; padding: 5px; border: 1px solid #ddd;">${valStr}</textarea>
            </div>
            <div style="display: flex; gap: 10px;">
                <button id="btn-save" onclick="saveItem()" disabled>Save</button>
                <button onclick="deleteItem()" style="background: #dc3545;">Delete</button>
            </div>
        `;
        document.getElementById('detail-resizer').style.display = 'block';
        panel.style.display = 'block';
    }

    function saveItem() {
        if (!currentStore || currentItemKey === null) return;

        const valText = document.getElementById('edit-value').value;
        let newVal;
        try {
            newVal = JSON.parse(valText);
        } catch (e) {
            alert("Invalid JSON in Value field");
            return;
        }

        const payload = {
            store: currentStore,
            key: currentItemKey,
            value: newVal
        };

        const btn = document.getElementById('btn-save');
        const originalText = btn.textContent;
        btn.textContent = "Saving...";
        btn.disabled = true;

        fetch('/api/store/item/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(res => {
            if (!res.ok) return res.text().then(t => { throw new Error(t) });
            return res.json();
        })
        .then(() => {
            // Success: Keep button disabled (greyed out) to indicate saved state
            btn.textContent = "Save";
            btn.disabled = true;
            
            // Refresh the grid in background to show updated values
            loadItems('current', firstKey);
        })
        .catch(err => {
            alert("Update failed: " + err.message);
            btn.textContent = "Save";
            btn.disabled = false; // Re-enable so user can try again
        });
    }

    function deleteItem() {
        if (!currentStore || currentItemKey === null) return;
        if (!confirm("Are you sure you want to delete this item?")) return;

        const payload = {
            store: currentStore,
            key: currentItemKey
        };

        fetch('/api/store/item/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(res => {
            if (!res.ok) return res.text().then(t => { throw new Error(t) });
            return res.json();
        })
        .then(() => {
            // Find index of deleted item to determine next selection
            let targetIndex = -1;
            if (currentItems && currentItems.length > 0) {
                // We need to compare keys carefully (objects vs primitives)
                const deletedKeyStr = JSON.stringify(currentItemKey);
                targetIndex = currentItems.findIndex(item => JSON.stringify(item.key) === deletedKeyStr);
            }

            loadItems('current', firstKey).then(newItems => {
                if (!newItems || newItems.length === 0) {
                    closeDetail();
                    return;
                }
                
                // Try to select item at same index, or last item if index out of bounds
                if (targetIndex >= 0) {
                    if (targetIndex >= newItems.length) {
                        targetIndex = newItems.length - 1;
                    }
                    showDetail(newItems[targetIndex]);
                } else {
                    // Fallback to first item if we couldn't track index
                    showDetail(newItems[0]);
                }
            });
        })
        .catch(err => {
            alert("Delete failed: " + err.message);
        });
    }

    function showAdd() {
        document.getElementById('add-modal').style.display = 'flex';
        document.getElementById('add-key').value = '';
        document.getElementById('add-value').value = '';
    }

    function closeAdd() {
        document.getElementById('add-modal').style.display = 'none';
    }

    function addItem() {
        if (!currentStore) return;

        const keyText = document.getElementById('add-key').value;
        const valText = document.getElementById('add-value').value;
        
        let key, val;
        try {
            // Try to parse key as JSON, if it fails use as string
            try {
                key = JSON.parse(keyText);
            } catch {
                key = keyText;
            }
            val = JSON.parse(valText);
        } catch (e) {
            alert("Invalid JSON in Value field");
            return;
        }

        const payload = {
            store: currentStore,
            key: key,
            value: val
        };

        fetch('/api/store/item/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(res => {
            if (!res.ok) return res.text().then(t => { throw new Error(t) });
            return res.json();
        })
        .then(() => {
            closeAdd();
            loadItems('current', firstKey);
        })
        .catch(err => {
            alert("Add failed: " + err.message);
        });
    }
    document.getElementById('detail-resizer').style.display = 'none';
    
    function closeDetail() {
        document.getElementById('detail-panel').style.display = 'none';
    }

    // Resizer Logic
    const sidebar = document.getElementById('sidebar');
    const resizer = document.getElementById('resizer');

    // Mouse Events
    resizer.addEventListener('mousedown', (e) => {
        e.preventDefault();
        document.addEventListener('mousemove', resize);
        document.addEventListener('mouseup', stopResize);
        resizer.classList.add('resizing');
        document.body.style.cursor = 'col-resize';
    });

    // Touch Events (for Mobile)
    resizer.addEventListener('touchstart', (e) => {
        e.preventDefault(); // Prevent scrolling while dragging
        document.addEventListener('touchmove', resize, { passive: false });
        document.addEventListener('touchend', stopResize);
        resizer.classList.add('resizing');
    }, { passive: false });

    function resize(e) {
        let clientX;
        if (e.type.startsWith('touch')) {
            clientX = e.touches[0].clientX;
        } else {
            clientX = e.clientX;
        }

        const newWidth = clientX;
        // Basic constraints - relaxed for mobile
        if (newWidth > 50 && newWidth < window.innerWidth - 50) {
            sidebar.style.width = newWidth + 'px';
        }
    }

    function stopResize() {
        document.removeEventListener('mousemove', resize);
        document.removeEventListener('mouseup', stopResize);
        document.removeEventListener('touchmove', resize);
        document.removeEventListener('touchend', stopResize);
        resizer.classList.remove('resizing');
        document.body.style.cursor = 'default';
    }

    // Detail Panel Resizer
    const detailPanel = document.getElementById('detail-panel');
    const detailResizer = document.getElementById('detail-resizer');

    detailResizer.addEventListener('mousedown', (e) => {
        e.preventDefault();
        document.addEventListener('mousemove', resizeDetail);
        document.addEventListener('mouseup', stopResizeDetail);
        detailResizer.classList.add('resizing');
        document.body.style.cursor = 'col-resize';
    });

    function resizeDetail(e) {
        const newWidth = window.innerWidth - e.clientX;
        if (newWidth > 200 && newWidth < window.innerWidth - 100) {
            detailPanel.style.width = newWidth + 'px';
        }
    }

    function stopResizeDetail() {
        document.removeEventListener('mousemove', resizeDetail);
        document.removeEventListener('mouseup', stopResizeDetail);
        detailResizer.classList.remove('resizing');
        document.body.style.cursor = 'default';
    }

    // Column Resizing
    let colResizingTh = null;
    let colStartX, colStartWidth;

    function initColResize(e) {
        e.stopPropagation();
        colResizingTh = e.target.parentElement;
        colStartX = e.clientX;
        colStartWidth = colResizingTh.offsetWidth;
        document.addEventListener('mousemove', doColResize, false);
        document.addEventListener('mouseup', stopColResize, false);
    }
    function doColResize(e) {
        if (colResizingTh) {
            const newWidth = colStartWidth + (e.clientX - colStartX);
            if (newWidth > 50) {
                colResizingTh.style.width = newWidth + 'px';
            }
        }
    }
    function stopColResize(e) {
        colResizingTh = null;
        document.removeEventListener('mousemove', doColResize, false);
        document.removeEventListener('mouseup', stopColResize, false);
    }
</script>

<div id="add-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
    <div style="background:white; padding:20px; border-radius:5px; width:500px; max-width:90%;">
        <h3>Add New Item</h3>
        <div style="margin-bottom:10px;">
            <label>Key (JSON or String):</label>
            <input type="text" id="add-key" style="width:100%; padding:5px; margin-top:5px;">
        </div>
        <div style="margin-bottom:10px;">
            <label>Value (JSON):</label>
            <textarea id="add-value" style="width:100%; height:200px; padding:5px; margin-top:5px; font-family:monospace;"></textarea>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button onclick="closeAdd()">Cancel</button>
            <button onclick="addItem()" style="background:#28a745; color:white;">Add</button>
        </div>
    </div>
</div>

</body>
</html>
