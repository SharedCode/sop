<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOP Data Browser</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; display: flex; height: 100vh; }
        #sidebar { width: 250px; min-width: 150px; max-width: 50%; background: #f4f4f4; border-right: 1px solid #ddd; padding: 20px; overflow-y: auto; flex-shrink: 0; }
        #resizer { width: 5px; background: #ddd; cursor: col-resize; user-select: none; transition: background 0.2s; }
        #resizer:hover, #resizer.resizing { background: #007bff; }
        #main { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; min-width: 300px; }
        h1, h2 { margin-top: 0; }
        ul { list-style: none; padding: 0; }
        li { padding: 8px 12px; cursor: pointer; border-radius: 4px; margin-bottom: 4px; }
        li:hover { background: #e0e0e0; }
        li.active { background: #007bff; color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; }
        tr:hover { background-color: #f1f1f1; cursor: pointer; }
        #detail-panel { width: 400px; border-left: 1px solid #ddd; padding: 20px; background: #fff; display: none; overflow-y: auto; }
        pre { background: #f8f8f8; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .toolbar { display: flex; gap: 10px; margin-bottom: 20px; }
        input[type="text"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; flex: 1; }
        button { padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>Stores</h2>
    <ul id="store-list">
        <li>Loading...</li>
    </ul>
</div>

<div id="resizer"></div>

<div id="main">
    <h1 id="current-store-title">Select a Store</h1>
    
    <div class="toolbar" id="toolbar" style="display:none;">
        <input type="text" id="search-input" placeholder="Search keys...">
        <button onclick="loadItems('search')">Search</button>
    </div>

    <div id="pagination-top" style="display:none; margin-bottom: 10px; gap: 10px; justify-content: center;">
        <button onclick="firstPage()">First</button>
        <button onclick="prevPage()">Previous</button>
        <button onclick="nextPage()">Next</button>
        <button onclick="lastPage()">Last</button>
    </div>

    <div id="data-grid"></div>
    
    <div id="pagination" style="display:none; margin-top: 10px; gap: 10px; justify-content: center;">
        <button onclick="firstPage()">First</button>
        <button onclick="prevPage()">Previous</button>
        <button onclick="nextPage()">Next</button>
        <button onclick="lastPage()">Last</button>
    </div>
</div>

<div id="detail-panel">
    <h2>Item Details</h2>
    <div id="json-viewer"></div>
</div>

<script>
    let currentStore = null;
    let firstKey = null;
    let lastKey = null;
    let currentStoreInfo = null;
    let currentItemKey = null;

    // Load Stores on Start
    fetch('/api/stores')
        .then(res => res.json())
        .then(stores => {
            const list = document.getElementById('store-list');
            list.innerHTML = '';
            stores.forEach(store => {
                const li = document.createElement('li');
                li.textContent = store;
                li.onclick = () => selectStore(store, li);
                list.appendChild(li);
            });
        });

    function selectStore(name, element) {
        currentStore = name;
        
        // Highlight active
        document.querySelectorAll('#sidebar li').forEach(el => el.classList.remove('active'));
        element.classList.add('active');

        // Fetch Store Info
        fetch(`/api/store/info?name=${encodeURIComponent(name)}`)
            .then(res => res.json())
            .then(info => {
                currentStoreInfo = info;
                // Use description if available, otherwise name
                const displayTitle = info.description ? info.description : info.name;
                document.getElementById('current-store-title').textContent = displayTitle;

                buildSearchUI(info);
                loadItems('first');
            });
    }

    function buildSearchUI(info) {
        const toolbar = document.getElementById('toolbar');
        toolbar.innerHTML = ''; // Clear existing
        toolbar.style.display = 'flex';
        toolbar.style.flexWrap = 'wrap';

        if (info.indexSpec && info.indexSpec.index_fields) {
            // Complex Key with Index Spec
            info.indexSpec.index_fields.forEach(field => {
                const input = document.createElement('input');
                input.type = 'text';
                input.id = `search-field-${field.field_name}`;
                input.placeholder = `${field.field_name} (${field.ascending_sort_order ? 'Asc' : 'Desc'})`;
                input.style.marginRight = '5px';
                input.style.flex = '1 1 150px'; // Allow wrapping
                toolbar.appendChild(input);
            });
        } else {
            // Primitive Key or no spec
            const input = document.createElement('input');
            input.type = 'text';
            input.id = 'search-input';
            input.placeholder = 'Search keys...';
            input.style.flex = '1';
            toolbar.appendChild(input);
        }

        const btn = document.createElement('button');
        btn.textContent = 'Search';
        btn.onclick = () => loadItems('search');
        toolbar.appendChild(btn);
    }

    function loadItems(action = 'first', refKey = null) {
        if (!currentStore) return;
        
        let url = `/api/store/items?name=${encodeURIComponent(currentStore)}`;
        
        if (action === 'search') {
             let query = "";
             if (currentStoreInfo && currentStoreInfo.indexSpec && currentStoreInfo.indexSpec.index_fields) {
                 // Construct JSON object from fields
                 const queryObj = {};
                 let hasValue = false;
                 currentStoreInfo.indexSpec.index_fields.forEach(field => {
                     const val = document.getElementById(`search-field-${field.field_name}`).value;
                     if (val) {
                         // Try to parse number if possible, else string
                         const numVal = Number(val);
                         queryObj[field.field_name] = isNaN(numVal) ? val : numVal;
                         hasValue = true;
                     }
                 });
                 if (hasValue) {
                     query = JSON.stringify(queryObj);
                 }
             } else {
                 query = document.getElementById('search-input').value;
             }
             
             if (query) {
                url += `&q=${encodeURIComponent(query)}`;
             } else {
                 // If search is empty, treat as first
                 action = 'first';
                 url += `&action=${action}`;
             }
        } else {
             url += `&action=${action}`;
             if (refKey) {
                 const keyStr = typeof refKey === 'object' ? JSON.stringify(refKey) : refKey;
                 url += `&key=${encodeURIComponent(keyStr)}`;
             }
        }

        fetch(url)
            .then(res => res.json())
            .then(items => {
                const grid = document.getElementById('data-grid');
                const pagination = document.getElementById('pagination');
                const paginationTop = document.getElementById('pagination-top');
                
                if (!items || items.length === 0) {
                    grid.innerHTML = '<p>No items found. <button onclick="loadItems(\'first\')">Go to First</button></p>';
                    pagination.style.display = 'none';
                    paginationTop.style.display = 'none';
                    firstKey = null;
                    lastKey = null;
                    return;
                }

                // Update keys
                firstKey = items[0].key;
                lastKey = items[items.length - 1].key;
                
                // Show pagination
                pagination.style.display = 'flex';
                paginationTop.style.display = 'flex';

                let html = '<table><thead><tr><th>Key</th><th>Value Preview</th></tr></thead><tbody>';
                items.forEach(item => {
                    const keyStr = typeof item.key === 'object' ? JSON.stringify(item.key) : item.key;
                    const valStr = JSON.stringify(item.value).substring(0, 50) + (JSON.stringify(item.value).length > 50 ? '...' : '');
                    html += `<tr onclick='showDetail(${JSON.stringify(item)})'>
                        <td>${keyStr}</td>
                        <td>${valStr}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                grid.innerHTML = html;
            });
    }

    function firstPage() { loadItems('first'); }
    function lastPage() { loadItems('last'); }
    function nextPage() { loadItems('next', lastKey); }
    function prevPage() { loadItems('prev', firstKey); }

    function showDetail(item) {
        const panel = document.getElementById('detail-panel');
        const viewer = document.getElementById('json-viewer');
        currentItemKey = item.key;
        
        const keyStr = typeof item.key === 'object' ? JSON.stringify(item.key, null, 2) : item.key;
        const valStr = JSON.stringify(item.value, null, 2);

        viewer.innerHTML = `
            <div style="margin-bottom: 10px;">
                <strong>Key:</strong>
                <pre style="margin-top: 5px; background: #eee; padding: 5px;">${keyStr}</pre>
            </div>
            <div style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                <strong>Value:</strong>
                <button onclick="closeDetail()" style="padding: 2px 8px; font-size: 12px;">Close</button>
            </div>
            <div style="margin-bottom: 10px;">
                <textarea id="edit-value" oninput="document.getElementById('btn-save').disabled = false;" style="width: 100%; height: 300px; font-family: monospace; margin-top: 5px; padding: 5px; border: 1px solid #ddd;">${valStr}</textarea>
            </div>
            <div style="display: flex; gap: 10px;">
                <button id="btn-save" onclick="saveItem()" disabled>Save</button>
            </div>
        `;
        panel.style.display = 'block';
    }

    function saveItem() {
        if (!currentStore || currentItemKey === null) return;

        const valText = document.getElementById('edit-value').value;
        let newVal;
        try {
            newVal = JSON.parse(valText);
        } catch (e) {
            alert("Invalid JSON in Value field");
            return;
        }

        const payload = {
            store: currentStore,
            key: currentItemKey,
            value: newVal
        };

        const btn = document.getElementById('btn-save');
        const originalText = btn.textContent;
        btn.textContent = "Saving...";
        btn.disabled = true;

        fetch('/api/store/item/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(res => {
            if (!res.ok) return res.text().then(t => { throw new Error(t) });
            return res.json();
        })
        .then(() => {
            // Success: Keep button disabled (greyed out) to indicate saved state
            btn.textContent = "Save";
            btn.disabled = true;
            
            // Refresh the grid in background to show updated values
            loadItems('first');
        })
        .catch(err => {
            alert("Update failed: " + err.message);
            btn.textContent = "Save";
            btn.disabled = false; // Re-enable so user can try again
        });
    }

    function closeDetail() {
        document.getElementById('detail-panel').style.display = 'none';
    }

    // Resizer Logic
    const sidebar = document.getElementById('sidebar');
    const resizer = document.getElementById('resizer');

    resizer.addEventListener('mousedown', (e) => {
        e.preventDefault();
        document.addEventListener('mousemove', resize);
        document.addEventListener('mouseup', stopResize);
        resizer.classList.add('resizing');
        document.body.style.cursor = 'col-resize'; // Prevent cursor flickering
    });

    function resize(e) {
        const newWidth = e.clientX;
        // Basic constraints
        if (newWidth > 150 && newWidth < window.innerWidth - 300) {
            sidebar.style.width = newWidth + 'px';
        }
    }

    function stopResize() {
        document.removeEventListener('mousemove', resize);
        document.removeEventListener('mouseup', stopResize);
        resizer.classList.remove('resizing');
        document.body.style.cursor = 'default';
    }
</script>

</body>
</html>
